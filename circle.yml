machine:
  ruby:
    version: 2.3.3 
compile:
  override:
    - bundle exec middleman build --verbose --environment=$CIRCLE_BRANCH
dependencies:
  pre:
    - wget https://releases.hashicorp.com/terraform/0.8.7/terraform_0.8.7_linux_amd64.zip
    - unzip terraform_0.8.7_linux_amd64.zip
    - ./terraform --version
test:
  override:
    - git clone git@github.com:artrunde/terraform-infrastructure.git --branch master
    - export S3_WWW_PATH=$(./terraform output -state=terraform-infrastructure/dev/services/frontend/terraform.tfstate s3_www_bucket_id)
    - export S3_ASSETS_PATH=$(./terraform output -state=terraform-infrastructure/dev/services/frontend/terraform.tfstate s3_assets_bucket_id)
deployment:
  production:
    branch: master
    commands:
      - aws s3 sync build/ s3://www.artrunde.com --delete --exclude "*.png"
      - aws s3 sync build/ s3://assets.artrunde.com --exclude "*" --include "images/*"
  development:
    branch: development
    commands:
      - aws s3 sync build/ s3://dev-www.artrunde.com --delete --exclude "*.png"
      - aws s3 sync build/ s3://dev-assets.artrunde.com --exclude "*" --include "images/*"
      - echo $S3_ASSET_PATH
      - echo $S3_WWW_PATH